<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Botnet Empire Idle - Botnet Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
* { 
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
body {
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background:#0d1117;
  color:#c9d1d9;
  overflow-x:hidden;
  touch-action: manipulation;
}
header {
  padding:20px 30px;
  background:#161b22;
  border-bottom:1px solid #30363d;
}
h1 { 
  margin:0; 
  font-size:clamp(14px, 4vw, 20px);
  font-weight:600;
  color:#58a6ff;
  letter-spacing:0.5px;
}
.event-timer {
  position:fixed;
  top:80px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255, 193, 7, 0.2);
  border:2px solid #ffc107;
  padding:16px 32px;
  border-radius:8px;
  font-size:clamp(11px, 2.5vw, 14px);
  color:#ffc107;
  z-index:1000;
  box-shadow:0 4px 16px rgba(0,0,0,0.6);
  text-align:center;
  min-width:280px;
  max-width:90vw;
  backdrop-filter:blur(4px);
}
.event-timer-label {
  font-weight:700;
  margin-bottom:6px;
  font-size:clamp(10px, 2.2vw, 13px);
  letter-spacing:1px;
  text-transform:uppercase;
}
.container {
  max-width:1600px;
  margin:0 auto;
  padding:clamp(10px, 3vw, 20px);
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(min(100%, 350px), 1fr));
  gap:clamp(12px, 2vw, 20px);
  margin-bottom:24px;
}
.panel {
  background:#161b22;
  padding:clamp(12px, 3vw, 20px);
  border:1px solid #30363d;
  border-radius:6px;
  margin-bottom:24px;
}
.panel h3 {
  margin:0 0 16px 0;
  color:#58a6ff;
  font-size:clamp(12px, 2.5vw, 14px);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  padding-bottom:12px;
  border-bottom:1px solid #21262d;
}
.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(min(100%, 140px), 1fr));
  gap:clamp(8px, 2vw, 12px);
}
.stat-card {
  background:#0d1117;
  padding:clamp(12px, 3vw, 16px);
  border:1px solid #30363d;
  border-radius:6px;
}
.stat-label {
  font-size:clamp(10px, 2vw, 11px);
  color:#8b949e;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
}
.stat-value {
  font-size:clamp(18px, 4vw, 24px);
  color:#58a6ff;
  font-weight:600;
}
button {
  background:#21262d;
  border:1px solid #30363d;
  color:#c9d1d9;
  padding:10px 16px;
  cursor:pointer;
  border-radius:6px;
  font-family:inherit;
  font-size:clamp(11px, 2.5vw, 13px);
  transition:all 0.2s;
  width:100%;
  margin-bottom:8px;
  touch-action:manipulation;
  user-select:none;
  -webkit-user-select:none;
}
button:hover:not(:disabled) {
  background:#30363d;
  border-color:#58a6ff;
}
button:active:not(:disabled) {
  transform:scale(0.98);
}
button:disabled {
  opacity:0.4;
  cursor:not-allowed;
}
button.active {
  background:#238636;
  border-color:#2ea043;
  color:#fff;
}
button.danger {
  background:#da3633;
  border-color:#f85149;
  color:#fff;
}
button.primary {
  background:#1f6feb;
  border-color:#58a6ff;
  color:#fff;
}
button.primary:hover:not(:disabled) {
  background:#388bfd;
}
button.small {
  padding:6px 10px;
  font-size:clamp(10px, 2vw, 11px);
  width:auto;
}
.tool-card {
  background:#0d1117;
  padding:14px;
  margin-bottom:12px;
  border:1px solid #30363d;
  border-radius:6px;
}
.tool-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  gap:8px;
  flex-wrap:wrap;
}
.tool-name {
  color:#58a6ff;
  font-weight:600;
  font-size:clamp(11px, 2.5vw, 13px);
}
.tool-status {
  font-size:clamp(10px, 2vw, 11px);
  padding:2px 8px;
  border-radius:12px;
  background:#21262d;
  color:#8b949e;
  white-space:nowrap;
}
.tool-status.active {
  background:#238636;
  color:#fff;
}
.tool-desc {
  font-size:clamp(11px, 2.2vw, 12px);
  color:#8b949e;
  margin-bottom:10px;
  line-height:1.4;
}
.tool-actions {
  display:flex;
  gap:8px;
}
.tool-actions button {
  margin:0;
}
input[type="number"] {
  background:#0d1117;
  border:1px solid #30363d;
  color:#c9d1d9;
  padding:8px 12px;
  border-radius:6px;
  font-family:inherit;
  font-size:clamp(11px, 2.5vw, 13px);
  width:100%;
  touch-action:manipulation;
}
input[type="number"]:focus {
  outline:none;
  border-color:#58a6ff;
}
.sell-tier {
  margin-bottom:16px;
  padding:12px;
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:6px;
}
.sell-tier-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  gap:8px;
  flex-wrap:wrap;
}
.sell-tier-name {
  font-size:clamp(11px, 2.5vw, 13px);
  font-weight:600;
  color:#c9d1d9;
}
.sell-tier-price {
  font-size:clamp(11px, 2.5vw, 13px);
  color:#58a6ff;
}
.sell-buttons-row {
  display:flex;
  gap:6px;
  margin-bottom:8px;
  align-items:flex-start;
  flex-wrap:nowrap;
}
.sell-scroll-container {
  overflow-x:auto;
  overflow-y:hidden;
  white-space:nowrap;
  flex:1;
  padding:0;
  max-width:100%;
}
.sell-scroll-container::-webkit-scrollbar {
  height:6px;
}
.sell-scroll-container::-webkit-scrollbar-track {
  background:#0d1117;
}
.sell-scroll-container::-webkit-scrollbar-thumb {
  background:#30363d;
  border-radius:3px;
}
.sell-scroll-buttons {
  display:inline-flex;
  gap:6px;
}
.custom-sell-container {
  display:flex;
  gap:6px;
  align-items:center;
  margin-top:8px;
}
.custom-sell-container input {
  flex:1;
  margin-bottom:0;
}
.custom-sell-container button {
  width:auto;
  margin-bottom:0;
}
canvas {
  width:100%;
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:6px;
  cursor:pointer;
  display:block;
  touch-action:manipulation;
}
#pieChart {
  height:clamp(160px, 30vh, 250px);
}
#moneyGraph {
  height:clamp(120px, 20vh, 180px);
}
.achievement {
  padding:10px;
  margin-bottom:8px;
  background:#0d1117;
  border-left:3px solid #30363d;
  border-radius:3px;
  font-size:clamp(11px, 2.2vw, 12px);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.achievement.done {
  border-left-color:#2ea043;
}
.achievement-text {
  color:#c9d1d9;
}
.achievement.done .achievement-text {
  color:#2ea043;
}
.achievement-reward {
  font-size:clamp(10px, 2vw, 11px);
  color:#8b949e;
}
.scrollable {
  max-height:min(400px, 50vh);
  overflow-y:auto;
  padding-right:8px;
}
.scrollable::-webkit-scrollbar {
  width:8px;
}
.scrollable::-webkit-scrollbar-track {
  background:#0d1117;
  border-radius:4px;
}
.scrollable::-webkit-scrollbar-thumb {
  background:#30363d;
  border-radius:4px;
}
.progress-bar {
  background:#0d1117;
  height:24px;
  border-radius:6px;
  overflow:hidden;
  position:relative;
  margin:12px 0;
  border:1px solid #30363d;
}
.progress-fill {
  background:#1f6feb;
  height:100%;
  transition:width 0.3s;
}
.progress-text {
  position:absolute;
  width:100%;
  text-align:center;
  line-height:24px;
  font-size:clamp(11px, 2.2vw, 12px);
  font-weight:600;
  color:#c9d1d9;
}
.tier-badge {
  display:inline-block;
  padding:2px 8px;
  border-radius:3px;
  font-size:clamp(9px, 2vw, 10px);
  font-weight:600;
  margin-left:6px;
}
.tier-t1 { background:#6e7681; color:#fff; }
.tier-t2 { background:#58a6ff; color:#000; }
.tier-t3 { background:#f85149; color:#fff; }
.tier-mobile { background:#ffc107; color:#000; }
.cooldown-bar {
  height:6px;
  background:#30363d;
  border-radius:3px;
  overflow:hidden;
  margin-top:8px;
}
.cooldown-fill {
  height:100%;
  background:#58a6ff;
  transition:width 0.1s linear;
}
#market {
  pointer-events: auto;
}

#market button {
  pointer-events: auto;
  position: relative;
  z-index: 2;
}
.modal-overlay {
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  animation:fadeIn 0.2s;
  padding:20px;
}
@keyframes fadeIn {
  from { opacity:0; }
  to { opacity:1; }
}
.modal {
  background:#161b22;
  border:1px solid #30363d;
  border-radius:6px;
  padding:clamp(16px, 4vw, 24px);
  max-width:600px;
  width:100%;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  max-height:80vh;
  overflow-y:auto;
}
.modal-title {
  font-size:clamp(14px, 3vw, 16px);
  font-weight:600;
  color:#58a6ff;
  margin-bottom:12px;
}
.modal-content {
  font-size:clamp(12px, 2.5vw, 14px);
  color:#c9d1d9;
  margin-bottom:20px;
  line-height:1.6;
}
.modal-content h4 {
  color:#58a6ff;
  font-size:clamp(12px, 2.5vw, 14px);
  margin:16px 0 8px 0;
}
.modal-content ul {
  margin:8px 0;
  padding-left:20px;
}
.modal-content li {
  margin:6px 0;
}
.skill-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(min(100%, 200px), 1fr));
  gap:12px;
}
.graph-container {
  position:relative;
}
.tooltip {
  position:absolute;
  background:#161b22;
  border:1px solid #58a6ff;
  padding:8px 12px;
  border-radius:6px;
  font-size:clamp(11px, 2.2vw, 12px);
  pointer-events:none;
  display:none;
  z-index:100;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.tooltip-label {
  color:#8b949e;
  font-size:clamp(9px, 2vw, 10px);
  margin-bottom:4px;
}
.tooltip-value {
  color:#58a6ff;
  font-weight:600;
  font-size:clamp(12px, 2.5vw, 14px);
}
.tool-tabs {
  display:flex;
  gap:8px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.tool-tab {
  padding:6px 12px;
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:6px;
  cursor:pointer;
  font-size:clamp(10px, 2vw, 11px);
  transition:all 0.2s;
  touch-action:manipulation;
  user-select:none;
  -webkit-user-select:none;
}
.tool-tab:hover {
  border-color:#58a6ff;
}
.tool-tab.active {
  background:#1f6feb;
  border-color:#58a6ff;
  color:#fff;
}
.tool-panel {
  display:none;
}
.tool-panel.active {
  display:block;
}
@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
  }
}
</style>
</head>
<body>

<header>
  <h1>BOTNET EMPIRE IDLE - BOTNET DASHBOARD</h1>
</header>

<div id="eventTimer" class="event-timer" style="display:none;"></div>
<div id="eventModal"></div>
<div id="tutorialModal"></div>

<div class="container">
  <div class="panel" style="margin-bottom:24px;">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Bots</div>
        <div class="stat-value" id="totalBots">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Available Funds</div>
        <div class="stat-value">$<span id="money">0</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Prestige Level</div>
        <div class="stat-value" id="prestige">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Bot Generation</div>
        <div class="stat-value"><span id="bps">0</span>/s</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Income Rate</div>
        <div class="stat-value">$<span id="mps">0</span>/s</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="exploitPanel">
      <h3>Device Exploitation</h3>
      <button class="primary" id="spreadBtn">Spread Network</button>
      <div style="font-size:clamp(10px, 2vw, 11px); color:#8b949e; margin-top:12px; margin-bottom:12px;">
        Click to generate random bot tier. Hold to generate 5 bots/sec.
      </div>
      
      <div id="toolsInterface"></div>
    </div>

    <div class="panel">
      <h3>Bot Distribution</h3>
      <div class="graph-container">
        <canvas id="pieChart"></canvas>
        <div id="pieTooltip" class="tooltip"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Total Earnings Over Time (Since Prestige)</h3>
    <div class="graph-container">
      <canvas id="moneyGraph"></canvas>
      <div id="moneyTooltip" class="tooltip"></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>Bot Inventory</h3>
      <div style="font-size:clamp(11px, 2.2vw, 12px); margin-bottom:8px;">
        <div style="margin-bottom:6px;">T1 Premium<span class="tier-t1">TIER 1</span>: <span style="color:#58a6ff; font-weight:600;" id="t1Count">0</span></div>
        <div style="margin-bottom:6px;">T2 Standard<span class="tier-t2">TIER 2</span>: <span style="color:#58a6ff; font-weight:600;" id="t2Count">0</span></div>
        <div style="margin-bottom:6px;">T3 Basic<span class="tier-t3">TIER 3</span>: <span style="color:#58a6ff; font-weight:600;" id="t3Count">0</span></div>
        <div id="mobileCount"></div>
      </div>
    </div>

    <div class="panel" id="marketPanel">
      <h3>Market Exchange Rates</h3>
      <div style="font-size:clamp(10px, 2vw, 11px); color:#8b949e; margin-bottom:12px;">
        Next update: <span id="priceTimer">--:--</span>
      </div>
      <div id="sellInterface"></div>
    </div>
  </div>
  
  <div class="panel" id="marketplacePanel">
    <h3>Equipment Upgrades</h3>
    <div id="upgrades"></div>
  </div>

  <div class="panel" id="marketplacePanel">
    <h3>Dark Web Marketplace</h3>
    <div class="scrollable" id="market"></div>
  </div>

  <div class="panel" id="skillsPanel">
    <h3>Skill Upgrades</h3>
    <div class="skill-grid" id="skills"></div>
  </div>

  <div class="panel">
    <h3>Achievement System</h3>
    <div class="scrollable" id="achievements"></div>
  </div>

  <div class="grid">
    <div class="panel" id="prestigePanel">
      <h3>Prestige System</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="prestigeProgress"></div>
        <div class="progress-text" id="prestigeText">0%</div>
      </div>
      <button class="primary" onclick="prestigeReset()">Execute Prestige Reset</button>
      <div style="font-size:clamp(10px, 2vw, 11px); color:#8b949e; margin-top:12px;">
        Requires: 8.2B total bots<br>
        Current Bonuses: +<span id="prestigeBonus">0</span>% income
      </div>
    </div>

    <div class="panel">
      <h3>Data Management</h3>
      <button onclick="exportSave()">Export Save Data</button>
      <button onclick="importSave()">Import Save Data</button>
      <button onclick="showTutorial()">Show Tutorial</button>
      <button class="danger" onclick="if(confirm('Permanently delete all data?'))resetGame()">Reset All Data</button>
    </div>
  </div>
</div>

<script>
const SAVE_KEY = "botnet_dashboard_v5";
const GRAPH_SAMPLE_INTERVAL = 10000;
const GRAPH_MAX_POINTS = 6048;

let game = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
  bots: { t1:0, t2:0, t3:0, mobile:0 },
  money:0,
  prestige:0,
  skills:{ tiers:0, prices:0, generation:0, automation:0 },
  tools:{},
  upgrades:{},
  prices:null,
  priceTime:0,
  lastSaveTime: 0,
  achievements:{},
  moneyGraph:[],
  unlocks:{ mobile:false },
  clickCooldowns:{},
  lastTick:Date.now(),
  lastGraphSample:Date.now(),
  activeEvent:null,
  eventEndTime:0,
  eventEffect:null,
  nextEventTime:Date.now() + (600000 + Math.random() * 1200000),
  totalEarned:0,
  totalClicks:0,
  totalBotsSold:0,
  activeToolTab:null,
  tutorialComplete:false,
  priceDirection:0,
  eventAcknowledged:false
};

if(!game.eventEffect) game.eventEffect = null;
if(!game.upgrades) game.upgrades = {};
if(!game.totalBotsSold) game.totalBotsSold = 0;
if(game.priceDirection === undefined) game.priceDirection = 0;
if(game.eventAcknowledged === undefined) game.eventAcknowledged = false;

let spreadHeld = false;
let spreadInterval = null;
let lastPriceUpdate = 0;
let lastMoney = 0;
let lastMobileState = false;
let purchaseInProgress = false;
let toolClickInProgress = false;
let spreadClickInProgress = false;
let marketplaceDirty = true;
let upgradesDirty = true;
let lastToolsState = "";

const upgrades = {
  buildPC:{ name:"Brand New Computer", desc:"Build your first desktop with top of the line specs", cost:500, effect:"base_bots", value:2 },
  clickv1:{ name:"External WiFi Antenna", desc:"Add an external WiFi antenna, providing more bots each time you spread your network.", cost:2500, type:"bots", base:25 },
  clickv2:{ name:"ProxyGambit", desc:"This reverse GSM-to-TCP bridge device allows you to proxy from thousands of miles away, giving you even more bots each time you spread your network.", cost:5000, type:"bots", base:150 }
};

const tools = {
  starter:{ name:"Wireless Deauthentication Tool", desc:"Forces nearby clients to disconnect from poorly secured access points", cost:1000, type:"bots", base:10, clickable:true, clickBonus:50, clickCooldown:60 },
  miniWorm:{ name:"Basic Propagation Script", desc:"A simple automated script that repeats successful intrusions without user input", cost:1500, type:"bots", base:50 },
  sqlTest:{ name:"SQL Injection Test Module", desc:"Automates detection and exploitation of improperly sanitized database queries", cost:2000, type:"bots", base:80 },
  autoClick:{ name:"Automated Interaction Engine", desc:"Simulates repetitive actions to rapidly expand compromised systems", cost:5000, type:"bots", base:500 },
  phishMini:{ name:"Test Phishing Campaign", desc:"Deploys targeted social engineering attempts with optional manual execution", cost:10000, type:"bots", base:800, clickable:true, clickBonus:2000, clickCooldown:180 },
  marketScanner:{ name:"Red Pill", desc:"Track the next market price trend for Tier 3 bots (↑) or (↓)", cost:15000, value:1 },
  credGrab:{ name:"Information Grabber", desc:"Collects stored usernames and passwords from compromised systems", cost:20000, type:"bots", base:1500 },
  botSeed:{ name:"Botnet Seeding Framework", desc:"Organizes newly compromised systems into a coordinated network", cost:30000, type:"bots", base:3000 },
  miniDdos:{ name:"Traffic Flood Utility", desc:"Generates short bursts of artificial network traffic on demand", cost:50000, type:"money", base:200, clickable:true, clickBonus:1000, clickCooldown:120 },
  sqli:{ name:"SQL Injection Automation Suite", desc:"Fully automates exploitation of vulnerable database-backed services", cost:100000, type:"bots", base:15000 },
  ddos:{ name:"Distributed Traffic Platform", desc:"Coordinates network load across multiple sources for paid disruption", cost:200000, type:"money", base:800, clickable:true, clickBonus:3000, clickCooldown:300 },
  xss:{ name:"Cross-Site Scripting Suite", desc:"Identifies and abuses client-side injection points in web applications", cost:300000, type:"bots", base:35000 },
  creds:{ name:"Credential Collection Service", desc:"Passively aggregates authentication data across compromised hosts", cost:400000, type:"bots", base:70000 },
  phishing:{ name:"Large Phishing Campaign", desc:"Manages large-scale email-based social engineering operations", cost:500000, type:"bots", base:120000 },
  spam:{ name:"Bulk Messaging Network", desc:"Distributes unsolicited messages across multiple platforms at scale", cost:1000000, type:"money", base:1500 },
  cards:{ name:"Payment Data Extraction", desc:"Extracts, filters, and categorizes harvested payment information", cost:1200000, type:"money", base:3000 },
  crypto:{ name:"Cryptocurrency Miner", desc:"Uses idle processing power across systems for computational revenue", cost:2000000, type:"money", base:4000 },
  worm:{ name:"Self-Propagating Worm", desc:"Autonomously spreads and adapts across new environments", cost:3000000, type:"bots", base:200000 },
  proxy:{ name:"Proxy Network Service", desc:"Anonymization service monetization", cost:3500000, type:"money", base:5500 },
  ransomware:{ name:"Ransomware Distribution", desc:"File encryption and ransom collection", cost:5e8, type:"money", base:7000, clickable:true, clickBonus:15000, clickCooldown:300 },
  mobile:{ name:"Mobile Device Loader", desc:"Unlock mobile device targeting", cost:7e8, unlocks:"mobile" },
  http:{ name:"HTTP Botnet Controller", desc:"An advanced HTTP botnet, maximizing evasion", cost:1.2e9, type:"bots", base:350000 },
  rootkit:{ name:"Advanced Rootkit System", desc:"Maintains long-term access by surviving reinstalls and updates", cost:2e9, type:"bots", base:500000 },
  backdoor:{ name:"Persistent Backdoor System", desc:"Ensures continuous remote access across compromised systems", cost:3.5e9, type:"bots", base:750000 },
  zeroday:{ name:"Zero-Day Exploit Kit", desc:"Unpatched vulnerability exploitation", cost:6e9, type:"bots", base:1200000, clickable:true, clickBonus:5000000, clickCooldown:300 }
};

const achievements = [
  {id:"first_pc", text:"Build your first desktop", reward:"generation", bonus:0.05, check:()=>game.upgrades.buildPC},
  {id:"hands_on", text:"Click Spread 200 times", reward:"click", bonus:0.25, check:()=>game.totalClicks>=200},
  {id:"market_init", text:"Sell bots for the first time", reward:"income", bonus:0.03, check:()=>game.totalBotsSold>0},
  {id:"small_batch", text:"Sell 1,000 total bots", reward:"income", bonus:0.05, check:()=>game.totalBotsSold>=1000},
  {id:"passive_income", text:"Reach 50 bot/sec generation", reward:"generation", bonus:0.05, check:()=>{
    let bps = 0;
    const mult = 1 + getPrestigeBonus() * 0.10;
    if(game.upgrades.buildPC) bps += 2 * mult;
    for(const id in game.tools){
      const t = tools[id];
      if(t && t.type === "bots" && game.tools[id].active){
        bps += t.base * 0.5 * mult;
      }
    }
    return bps >= 50;
  }},
  {id:"cooldown_aware", text:"Trigger a tool cooldown", reward:"cooldown", bonus:0.05, check:()=>{
    for(const id in game.clickCooldowns){
      if(game.clickCooldowns[id] > 0) return true;
    }
    return false;
  }},
  {id:"steady_growth", text:"Earn $5,000 total", reward:"income", bonus:0.05, check:()=>game.totalEarned>=5000},
  {id:"automation_first", text:"Passive generation exceeds clicks", reward:"automation", bonus:0.05, check:()=>{
    let bps = 0;
    const mult = (1 + game.skills.generation * 0.10 + game.skills.automation * 0.05 + getPrestigeBonus() * 0.10) * getAchievementBonus("generation");
    if(game.upgrades.buildPC) bps += 2 * mult;
    for(const id in game.tools){
      const t = tools[id];
      if(t && t.type === "bots" && game.tools[id].active){
        bps += t.base * 0.5 * mult;
      }
    }
    return bps > 0 && game.totalClicks > 0 && bps > (game.totalClicks / ((Date.now() - game.lastTick) / 1000 / 60));
  }},
  {id:"early_planner", text:"Purchase 5 upgrades or tools", reward:"generation", bonus:0.05, check:()=>(Object.keys(game.upgrades).length + Object.keys(game.tools).length)>=5},
  {id:"first_thousand", text:"Acquire 1,000 total bots", reward:"income", bonus:0.02, check:()=>getTotalBots()>=1000},
  {id:"first_10k", text:"Acquire 10,000 total bots", reward:"generation", bonus:0.03, check:()=>getTotalBots()>=10000},
  {id:"first_100k", text:"Acquire 100,000 total bots", reward:"generation", bonus:0.05, check:()=>getTotalBots()>=100000},
  {id:"first_million", text:"Acquire 1M total bots", reward:"generation", bonus:0.08, check:()=>getTotalBots()>=1e6},
  {id:"first_10m", text:"Acquire 10M total bots", reward:"generation", bonus:0.10, check:()=>getTotalBots()>=1e7},
  {id:"first_billion", text:"Acquire 1B total bots", reward:"generation", bonus:0.15, check:()=>getTotalBots()>=1e9},
  {id:"rich", text:"Earn $1M total", reward:"income", bonus:0.03, check:()=>game.totalEarned>=1e6},
  {id:"very_rich", text:"Earn $10M total", reward:"income", bonus:0.05, check:()=>game.totalEarned>=1e7},
  {id:"mega_rich", text:"Earn $100M total", reward:"income", bonus:0.08, check:()=>game.totalEarned>=1e8},
  {id:"ultra_rich", text:"Earn $1B total", reward:"income", bonus:0.10, check:()=>game.totalEarned>=1e9},
  {id:"clicks_100", text:"Click Spread 100 times", reward:"generation", bonus:0.02, check:()=>game.totalClicks>=100},
  {id:"clicks_1000", text:"Click Spread 1,000 times", reward:"generation", bonus:0.05, check:()=>game.totalClicks>=1000},
  {id:"tools_1", text:"Purchase first tool", reward:"generation", bonus:0.03, check:()=>Object.keys(game.tools).length>=1},
  {id:"tools_3", text:"Purchase 3 tools", reward:"income", bonus:0.05, check:()=>Object.keys(game.tools).length>=3},
  {id:"tools_5", text:"Purchase 5 tools", reward:"income", bonus:0.08, check:()=>Object.keys(game.tools).length>=5},
  {id:"tools_10", text:"Purchase 10 tools", reward:"generation", bonus:0.12, check:()=>Object.keys(game.tools).length>=10},
  {id:"tools_all", text:"Purchase all tools", reward:"income", bonus:0.10, check:()=>Object.keys(game.tools).length>=Object.keys(tools).length},
  {id:"mobile_unlock", text:"Unlock mobile infrastructure", reward:"generation", bonus:0.05, check:()=>game.unlocks.mobile},
  {id:"prestige_1", text:"Complete first prestige", reward:"prestige", bonus:1, check:()=>game.prestige>=1},
  {id:"prestige_3", text:"Complete 3 prestiges", reward:"prestige", bonus:2, check:()=>game.prestige>=3},
  {id:"prestige_5", text:"Complete 5 prestiges", reward:"prestige", bonus:3, check:()=>game.prestige>=5}
];

function showTutorial(){
  const modal = document.getElementById("tutorialModal");
  modal.innerHTML = `
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-title">Welcome to Botnet Empire Idle</div>
        <div class="modal-content">
          <h4>Game Overview</h4>
          <p>Build and manage a botnet empire. Generate bots, sell them for profit, purchase tools, and eventually prestige to multiply your earnings.</p>
          
          <h4>Getting Started</h4>
          <ul>
            <li><strong>Spread Network Button:</strong> Click to generate 10 random bots. Hold to generate 5 bots/sec continuously.</li>
            <li><strong>Bot Tiers:</strong> T3 (Basic, 72% chance), T2 (Standard, 22%), T1 (Premium, 6%). Higher tiers sell for more.</li>
          </ul>
          
          <h4>Selling Bots</h4>
          <ul>
            <li>Navigate to "Market Exchange Rates" to sell bots for money.</li>
            <li>Prices update every 30 minutes: T1 ($0.80-$1.25), T2 ($0.30-$0.80), T3 ($0.08-$0.30).</li>
            <li>Use preset buttons (100-500M) or enter a custom amount.</li>
          </ul>
          
          <h4>Dark Web Marketplace</h4>
          <ul>
            <li><strong>Bot Generation Tools:</strong> SQL Injection Module, XSS Kit, Credential Harvester, etc. - generate bots passively.</li>
            <li><strong>Money Generation Tools:</strong> DDoS Platform, Card Dumper, Ransomware - generate income passively.</li>
            <li><strong>Clickable Tools:</strong> Some tools (SQLi, DDoS, Ransomware, Zero-Day) have bonus click actions. Click 50 times then 5-minute cooldown.</li>
          </ul>
          
          <h4>Skill Upgrades</h4>
          <ul>
            <li><strong>Bot Tier Distribution:</strong> +5% chance for better tiers per level.</li>
            <li><strong>Market Efficiency:</strong> +10% sell prices per level.</li>
            <li><strong>Bot Generation Rate:</strong> +10% passive bot generation per level.</li>
            <li><strong>Automation Efficiency:</strong> +5% tool effectiveness per level.</li>
          </ul>
          
          <h4>Achievements</h4>
          <p>Completing achievements grants permanent bonuses: income boosts, generation boosts, or extra prestige levels.</p>
          
          <h4>Prestige System</h4>
          <ul>
            <li>Reach 8.2B total bots to prestige.</li>
            <li>Resets bots, money, tools, and skills but keeps achievements.</li>
            <li>Each prestige grants +10% income and generation permanently.</li>
            <li>Game balanced for ~1 week per prestige.</li>
          </ul>
          
          <h4>Random Events</h4>
          <p>Events occur every 10-30 minutes: FBI raids (-30% bots), ISP outages (-50% income), or exploit discoveries (+100% bots). Effects last 90-120 seconds.</p>
        </div>
        <button class="primary" onclick="closeTutorial()">Start Playing</button>
      </div>
    </div>
  `;
  game.tutorialComplete = true;
}

function closeTutorial(){
  document.getElementById("tutorialModal").innerHTML = "";
}

function safeInt(n){
  return Math.floor(n + 1e-9);
}

document.getElementById("bps").textContent = safeInt(bps);
document.getElementById("mps").textContent = safeInt(mps);

function rollPrices(){
  const oldPrices = game.prices;
  game.prices = {
    t1:(Math.random()*0.45+0.8),
    t2:(Math.random()*0.5+0.3),
    t3:(Math.random()*0.22+0.08),
    mobile:(Math.random()*0.8+1.2)
  };
  
  if(oldPrices && game.upgrades.marketScanner){
    game.priceDirection = game.prices.t3 > oldPrices.t3 ? 1 : (game.prices.t3 < oldPrices.t3 ? -1 : 0);
  }
  
  game.priceTime = Date.now();
}
if(!game.prices || Date.now()-game.priceTime>1800000) rollPrices();

function getTotalBots(){
  return game.bots.t1 + game.bots.t2 + game.bots.t3 + game.bots.mobile;
}

function getAchievementBonus(type){
  let bonus = 1;
  for(const a of achievements){
    if(game.achievements[a.id] && a.reward === type){
      bonus += a.bonus;
    }
  }
  return bonus;
}

function getCooldownReduction(){
  let reduction = 1;
  for(const a of achievements){
    if(game.achievements[a.id] && a.reward === "cooldown"){
      reduction -= a.bonus;
    }
  }
  return Math.max(0.1, reduction);
}

function getPrestigeBonus(){
  let extraPrestige = 0;
  for(const a of achievements){
    if(game.achievements[a.id] && a.reward === "prestige"){
      extraPrestige += a.bonus;
    }
  }
  return game.prestige + extraPrestige;
}

function startSpread(){
  if(!spreadHeld){
    spread(); // Initial click
    spreadHeld = true;
    spreadInterval = setInterval(() => {
      spread(); // Call spread() instead of directly adding T3
    }, 200); // Every 200ms instead of 1000ms for better responsiveness
  }
}

function stopSpread(){
  spreadHeld = false;
  if(spreadInterval){
    clearInterval(spreadInterval);
    spreadInterval = null;
  }
}

function spread(){
  if(spreadClickInProgress) return;
  spreadClickInProgress = true;
  
  game.totalClicks++;
  const tierBonus = game.skills.tiers * 0.05;
  const roll = Math.random() + tierBonus;
  
  let clickMult = 1;
  clickMult *= getAchievementBonus("click");
  
  const amount = Math.floor(10 * clickMult);
  
  if(game.unlocks.mobile && roll > 0.98) game.bots.mobile += amount;
  else if(roll > 0.94) game.bots.t1 += amount;
  else if(roll > 0.72) game.bots.t2 += amount;
  else game.bots.t3 += amount;
  
  setTimeout(() => { spreadClickInProgress = false; }, 50);
}

function sell(tier, amount){
  amount = Math.max(0, Math.floor(amount));
  if(amount === 0) return;
  
  if(amount > 50000000){
    if(!confirm(`Sell ${amount.toLocaleString()} ${tier.toUpperCase()} bots?`)) return;
  }
  
  if(game.bots[tier] >= amount){
    game.bots[tier] -= amount;
    game.totalBotsSold += amount;
    
    let priceBonus = 1 + game.skills.prices * 0.03;
    
    const prestigeBonus = 1 + getPrestigeBonus() * 0.10;
    const achievementBonus = getAchievementBonus("income");
    const earned = amount * game.prices[tier] * priceBonus * prestigeBonus * achievementBonus;
    game.money += earned;
    game.totalEarned += earned;
	saveGame();
  }
}

function sellCustom(tier){
  const input = document.getElementById(`sell_custom_${tier}`);
  if(!input) return;
  
  let amount = parseInt(input.value);
  
  if(isNaN(amount) || amount <= 0) {
    input.value = "";
    return;
  }
  
  amount = Math.min(amount, Math.floor(game.bots[tier]));
  
  if(amount > 0){
    sell(tier, amount);
    input.value = "";
  }
}

function buyUpgrade(id){
  if(purchaseInProgress) return;
  
  // Check if this is a skill upgrade
  if(['tiers', 'prices', 'generation', 'automation'].includes(id)) {
    const baseCosts = {
      tiers: 5e5,
      prices: 1e6,
      generation: 2e6,
      automation: 5e6
    };
    const baseCost = baseCosts[id];
    const cost = baseCost * Math.pow(1.6, game.skills[id]);
    
    if(game.money >= cost){
      purchaseInProgress = true;
      game.money -= cost;
      game.skills[id]++;
	  
	  saveGame();
      
      // Update UI immediately
      marketplaceDirty = true;
      upgradesDirty = true;
      
      setTimeout(() => { 
        purchaseInProgress = false;
        render(); // Force full render to update button states
      }, 100);
    }
    return;
  }
  
  // Check if this is a regular upgrade
  const u = upgrades[id];
  if(!u || game.upgrades[id]) return;

  if(game.money >= u.cost){
    purchaseInProgress = true;
    game.money -= u.cost;
    game.upgrades[id] = true;

    // Mark for re-render
    marketplaceDirty = true;
    upgradesDirty = true;

    setTimeout(() => { 
      purchaseInProgress = false;
      render(); // Force full render to update button states
    }, 100);
  }
}

function buyTool(id){
  if(purchaseInProgress) return;

  const t = tools[id];
  if(!t || game.tools[id]) return;

  if(game.money >= t.cost){
    purchaseInProgress = true;
    game.money -= t.cost;
    
    // Initialize tool as active
    game.tools[id] = { active: true, clicks: 0 };
    
    // Force UI updates
    marketplaceDirty = true;
    upgradesDirty = true;
    lastToolsState = ""; // Force tools interface refresh
    
    // Immediate UI feedback
    render();
    
    setTimeout(() => {
      purchaseInProgress = false;
    }, 100);
  }
}

function activateTool(id) {
  if(game.tools[id]) {
    game.tools[id].active = !game.tools[id].active;
  }
}

window.addEventListener('beforeunload', () => {
  saveGame();
});

document.addEventListener('visibilitychange', () => {
  if(document.hidden) {
    saveGame();
  }
});

window.addEventListener("load", () => {
  // Try to load from localStorage first
  const saved = localStorage.getItem(SAVE_KEY);
  if(saved){
    try {
      const parsed = JSON.parse(saved);
      // Merge with default game structure to ensure all properties exist
      game = {
        ...game, // Default structure
        ...parsed, // Saved data
        // Ensure critical properties exist
        bots: parsed.bots || game.bots,
        money: parsed.money || 0,
        prestige: parsed.prestige || 0,
        skills: parsed.skills || { tiers:0, prices:0, generation:0, automation:0 },
        tools: parsed.tools || {},
        upgrades: parsed.upgrades || {},
        achievements: parsed.achievements || {},
        unlocks: parsed.unlocks || { mobile:false }
      };
      
      // Ensure moneyGraph exists
      if(!Array.isArray(game.moneyGraph)) game.moneyGraph = [];
      
      console.log("Game loaded from save");
    } catch(e) {
      console.error("Error loading save:", e);
      // Keep default game
    }
  }
  
  // Initialize with current time
  game.lastTick = Date.now();
  if(!game.lastGraphSample) game.lastGraphSample = Date.now();
  
  // Ensure prices exist
  if(!game.prices || Date.now()-game.priceTime>1800000) rollPrices();
  
  render();
  drawCharts();
  
  // Start the game loop
  setInterval(update, 100);
  update();
});

function saveGame() {
  try {
    // Update timestamp before saving
    game.lastTick = Date.now();
    
    // Stringify with error handling
    const saveData = JSON.stringify(game);
    localStorage.setItem(SAVE_KEY, saveData);
    
    // Optional: Log success (remove in production)
    console.log("Game saved successfully");
  } catch(e) {
    console.error("Error saving game:", e);
  }
}

function update(){
  const now = Date.now();
  const delta = Math.min((now - game.lastTick) / 1000, 1);
  game.lastTick = now;
  
  let botMult = 1 + game.skills.generation * 0.05 + game.skills.automation * 0.05 + getPrestigeBonus() * 0.10;
  let moneyMult = 1 + getPrestigeBonus() * 0.10;
  
  botMult *= getAchievementBonus("generation");
  botMult *= getAchievementBonus("automation");
  moneyMult *= getAchievementBonus("income");
  
  if(game.activeEvent === "raid" && game.eventAcknowledged) botMult *= 0.7;
  if(game.activeEvent === "outage" && game.eventAcknowledged) moneyMult *= 0.5;
  if(game.activeEvent === "boom" && game.eventAcknowledged) botMult *= 2;
  
  if(game.upgrades.buildPC){
    game.bots.t3 += 1 * botMult * delta;
  }
  
  for(const id in game.tools){
    const t = tools[id];
    if(!t || !t.type) continue;
    const active = game.tools[id].active ? 0.5 : 0;
    if(t.type === "bots"){
      game.bots.t3 += t.base * active * botMult * delta;
    } else if(t.type === "money"){
      const earned = t.base * active * moneyMult * delta;
      game.money += earned;
      game.totalEarned += earned;
    }
  }
  
  for(const id in game.clickCooldowns){
    if(game.clickCooldowns[id] > 0){
      game.clickCooldowns[id] -= delta;
      if(game.clickCooldowns[id] < 0) game.clickCooldowns[id] = 0;
    }
  }
  
  if(now - game.lastGraphSample >= GRAPH_SAMPLE_INTERVAL){
    game.moneyGraph.push(game.totalEarned);
    if(game.moneyGraph.length > GRAPH_MAX_POINTS) game.moneyGraph.shift();
    game.lastGraphSample = now;
  }
  
  let priceRollTime = 1800000;
  
  if(Date.now() - game.priceTime > priceRollTime) rollPrices();
  
  // Save every 5 seconds AND on important events
  if(!game.lastSaveTime || now - game.lastSaveTime > 5000) {
    saveGame();
    game.lastSaveTime = now;
  }
  
  triggerEvent();
  drawCharts();
  render();
}

// Also save on important actions:
function buyTool(id){
  if(purchaseInProgress) return;

  const t = tools[id];
  if(!t || game.tools[id]) return;

  if(game.money >= t.cost){
    purchaseInProgress = true;
    game.money -= t.cost;
    game.tools[id] = { active:true, clicks:0 };
    
    // Save immediately after purchase
    saveGame();
    
    setTimeout(() => { 
      purchaseInProgress = false;
      render();
    }, 100);
  }
}

function clickTool(id){
  if(toolClickInProgress) return;
  const t = tools[id];
  const cd = game.clickCooldowns[id] || 0;
  if(cd > 0) return;
  
  toolClickInProgress = true;
  
  game.tools[id].clicks = (game.tools[id].clicks || 0) + 1;
  
  const prestigeBonus = 1 + getPrestigeBonus() * 0.10;
  const achievementBonus = getAchievementBonus(t.type === "bots" ? "generation" : "income");
  
  if(t.type === "bots"){
    game.bots.t3 += t.clickBonus * prestigeBonus * achievementBonus;
  } else if(t.type === "money"){
    const earned = t.clickBonus * prestigeBonus * achievementBonus;
    game.money += earned;
    game.totalEarned += earned;
  }
  
  if(game.tools[id].clicks >= 50){
    const cooldownReduction = getCooldownReduction();
    game.clickCooldowns[id] = t.clickCooldown * cooldownReduction;
    game.tools[id].clicks = 0;
  }
  
  setTimeout(() => { toolClickInProgress = false; }, 50);
}

function upgrade(skill){
  if(purchaseInProgress) return;
  const baseCosts = {
    tiers: 5e5,
    prices: 1e6,
    generation: 2e6,
    automation: 5e6
  };
  const baseCost = baseCosts[skill];
  const cost = baseCost * Math.pow(1.6, game.skills[skill]);
  
  if(game.money >= cost){
    purchaseInProgress = true;
    game.money -= cost;
    game.skills[skill]++;
	
	saveGame();
    
    // Update UI immediately
    marketplaceDirty = true;
    upgradesDirty = true;
    
    setTimeout(() => { 
      purchaseInProgress = false;
      render(); // Force full render to update button states
    }, 100);
  }
}

function getClickPower(){
  let power = 1;

  power *= 1 + (game.skills.automation || 0) * 0.05;
  power *= 1 + (game.skills.generation || 0) * 0.02;

  if(game.upgrades.click_boost_1) power *= 2;
  if(game.upgrades.click_boost_2) power *= 3;

  return Math.floor(power);
}

function prestigeReset(){
  if(getTotalBots() >= 8.2e9){
    if(!confirm('Prestige will reset all progress except achievements. Continue?')) return;
    
    game.prestige++;
    game.bots = {t1:0, t2:0, t3:0, mobile:0};
    game.money = 0;
    game.totalEarned = 0;
    game.totalBotsSold = 0;
    game.tools = {};
    game.upgrades = {};
    game.clickCooldowns = {};
    game.unlocks.mobile = false;
    game.moneyGraph = [];
    game.activeToolTab = null;
    game.totalClicks = 0;
    game.skills = { tiers:0, prices:0, generation:0, automation:0 };
    game.lastGraphSample = Date.now();
    game.activeEvent = null;
    game.eventEffect = null;
    game.eventEndTime = 0;
    game.eventAcknowledged = false;
    game.nextEventTime = Date.now() + (600000 + Math.random() * 1200000);
  }
}

function showEvent(event){
  const modal = document.getElementById("eventModal");
  modal.innerHTML = `
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-title">${event.title}</div>
        <div class="modal-content">${event.text}</div>
        <button class="primary" onclick="acknowledgeEvent()">Acknowledge</button>
      </div>
    </div>
  `;
}

function acknowledgeEvent(){
  game.eventAcknowledged = true;
  document.getElementById("eventModal").innerHTML = "";
}

function triggerEvent(){
  const now = Date.now();
  
  if(game.activeEvent && now >= game.eventEndTime){
    game.activeEvent = null;
    game.eventEffect = null;
    game.eventAcknowledged = false;
  }
  
  if(!game.activeEvent && now >= game.nextEventTime){
    const events = [
      {title:"SECURITY ALERT", text:"FBI raid detected on network infrastructure. Bot generation reduced by 30% for 2 minutes.", type:"raid", duration:120000, effect:"Bot generation -30%"},
      {title:"NETWORK OUTAGE", text:"Major ISP experiencing service disruption. Income generation reduced by 50% for 90 seconds.", type:"outage", duration:90000, effect:"Income generation -50%"},
      {title:"EXPLOIT DISCOVERED", text:"Critical zero-day vulnerability identified. Bot generation increased by 100% for 2 minutes.", type:"boom", duration:120000, effect:"Bot generation +100%"}
    ];
    
    const event = events[Math.floor(Math.random() * events.length)];
    game.activeEvent = event.type;
    game.eventEndTime = now + event.duration;
    game.eventEffect = event.effect;
    game.eventAcknowledged = false;
    game.nextEventTime = now + event.duration + (600000 + Math.random() * 1200000);
    
    showEvent(event);
  }
}

function updateSellButtonStates(){
  const tiers = ['t1', 't2', 't3'];
  if(game.unlocks.mobile) tiers.push('mobile');
  
  tiers.forEach(tier => {
    const buttons = document.querySelectorAll(`.sell-btn-${tier}`);
    buttons.forEach(btn => {
      const amount = parseInt(btn.getAttribute('data-amount'));
      btn.disabled = game.bots[tier] < amount;
    });
    
    const input = document.getElementById(`sell_custom_${tier}`);
    if(input){
      input.max = Math.floor(game.bots[tier]);
    }
  });
}

function render(){
  const total = getTotalBots();
  document.getElementById("totalBots").textContent = Math.floor(total).toLocaleString();
  document.getElementById("money").textContent = Math.floor(game.money).toLocaleString();
  document.getElementById("prestige").textContent = game.prestige;
  
  let bps = 0, mps = 0;
  const botMult = (1 + game.skills.generation * 0.05 + game.skills.automation * 0.05 + getPrestigeBonus() * 0.10) * getAchievementBonus("generation") * getAchievementBonus("automation");
  const moneyMult = (1 + getPrestigeBonus() * 0.10) * getAchievementBonus("income");
  
  if(game.upgrades.buildPC){
    bps += 2 * botMult;
  }
  
  for(const id in game.tools){
    const t = tools[id];
    if(!t || !t.type) continue;
    const active = game.tools[id].active ? 0.5 : 0;
    if(t.type === "bots") bps += t.base * active * botMult;
    if(t.type === "money") mps += t.base * active * moneyMult;
  }
  
  document.getElementById("bps").textContent = Math.floor(bps);
  document.getElementById("mps").textContent = Math.floor(mps);
  
  document.getElementById("t1Count").textContent = Math.floor(game.bots.t1).toLocaleString();
  document.getElementById("t2Count").textContent = Math.floor(game.bots.t2).toLocaleString();
  document.getElementById("t3Count").textContent = Math.floor(game.bots.t3).toLocaleString();
  
  if(game.unlocks.mobile){
    const mobileCountEl = document.getElementById("mobileCount");
    if(mobileCountEl){
      mobileCountEl.innerHTML = `<div style="margin-bottom:6px;">Mobile Devices<span class="tier-mobile">MOBILE</span>: <span style="color:#58a6ff; font-weight:600;">${Math.floor(game.bots.mobile).toLocaleString()}</span></div>`;
    }
  } else {
    const mobileCountEl = document.getElementById("mobileCount");
    if(mobileCountEl) mobileCountEl.innerHTML = "";
  }
  
  const priceRollTime = 1800;
  const timeLeft = Math.max(0, priceRollTime - Math.floor((Date.now() - game.priceTime) / 1000));
  const mins = Math.floor(timeLeft / 60);
  const secs = timeLeft % 60;
  const priceTimerEl = document.getElementById("priceTimer");
  if(priceTimerEl){
    let timerText = `${mins}:${secs.toString().padStart(2,'0')}`;
    if(game.upgrades.marketScanner && game.priceDirection !== 0){
      timerText += game.priceDirection > 0 ? ' (↑)' : ' (↓)';
    }
    priceTimerEl.textContent = timerText;
  }
  
  if(game.activeEvent && game.eventAcknowledged && Date.now() < game.eventEndTime){
    const remaining = Math.ceil((game.eventEndTime - Date.now()) / 1000);
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    const eventTimer = document.getElementById("eventTimer");
    if(eventTimer){
      eventTimer.innerHTML = `
        <div class="event-timer-label">${game.activeEvent.toUpperCase()} ACTIVE</div>
        <div>${game.eventEffect || ''} - ${m}:${s.toString().padStart(2,'0')} remaining</div>
      `;
      eventTimer.style.display = "block";
    }
  } else {
    const eventTimer = document.getElementById("eventTimer");
    if(eventTimer) eventTimer.style.display = "none";
  }
  
  if(game.priceTime !== lastPriceUpdate || game.unlocks.mobile !== lastMobileState){
    renderSellInterface();
    lastPriceUpdate = game.priceTime;
    lastMobileState = game.unlocks.mobile;
  } else {
    updateSellButtonStates();
  }
  
  renderSkills();
  renderAchievements();
  
  if(game.money !== lastMoney){
    marketplaceDirty = true;
    upgradesDirty = true;
    lastMoney = game.money;
  }
  
  if(upgradesDirty){
    renderUpgrades();
    upgradesDirty = false;
  }

  if(marketplaceDirty){
    renderMarketplace();
    marketplaceDirty = false;
  }
  
  const toolsStateKey = JSON.stringify({
    tools: Object.keys(game.tools).sort(),
    activeTab: game.activeToolTab,
    toolStates: Object.keys(game.tools).map(id => game.tools[id].active)
  });
  
  if(toolsStateKey !== lastToolsState){
    renderToolsInterface();
    lastToolsState = toolsStateKey;
  } else {
    updateToolsInterfaceDynamic();
  }
  
  const progress = Math.min(100, (total / 8.2e9) * 100);
  document.getElementById("prestigeProgress").style.width = progress + "%";
  document.getElementById("prestigeText").textContent = progress.toFixed(2) + "%";
  document.getElementById("prestigeBonus").textContent = (getPrestigeBonus() * 10);
}

function renderSellInterface(){
  const sellUI = document.getElementById("sellInterface");
  sellUI.innerHTML = "";
  
  const tiers = [
    {key:"t1", label:"T1 Premium", price:game.prices.t1},
    {key:"t2", label:"T2 Standard", price:game.prices.t2},
    {key:"t3", label:"T3 Basic", price:game.prices.t3}
  ];
  if(game.unlocks.mobile) tiers.push({key:"mobile", label:"Mobile", price:game.prices.mobile});
  
  tiers.forEach(t => {
    const amounts = [100, 250, 500, 1000, 10000, 25000, 50000, 100000, 250000, 1000000, 5000000, 250000000, 500000000];
    
    const tierDiv = document.createElement('div');
    tierDiv.className = 'sell-tier';
    tierDiv.innerHTML = `
      <div class="sell-tier-header">
        <div class="sell-tier-name">${t.label}</div>
        <div class="sell-tier-price">${t.price.toFixed(3)}/bot</div>
      </div>
      <div class="sell-buttons-row">
        <div class="sell-scroll-container">
          <div class="sell-scroll-buttons">
            ${amounts.map(amt => `
              <button class="small sell-btn-${t.key}" data-amount="${amt}" onclick="sell('${t.key}', ${amt}); event.stopPropagation();" ${game.bots[t.key]<amt?'disabled':''}>
                ${amt >= 1000000 ? (amt/1000000)+'M' : amt >= 1000 ? (amt/1000)+'k' : amt}
              </button>
            `).join('')}
          </div>
        </div>
      </div>
      <div class="custom-sell-container">
        <input type="number" id="sell_custom_${t.key}" placeholder="Custom amount" min="1" max="${Math.floor(game.bots[t.key])}">
        <button class="small" onclick="sellCustom('${t.key}'); event.stopPropagation();">Sell Custom</button>
      </div>
    `;
    
    sellUI.appendChild(tierDiv);
    
    const input = document.getElementById(`sell_custom_${t.key}`);
    if(input){
      ['click', 'focus', 'mousedown', 'touchstart'].forEach(evt => {
        input.addEventListener(evt, (e) => e.stopPropagation(), {passive: true});
      });
    }
  });
}

function renderUpgrades(){
  const upgradesUI = document.getElementById("upgrades");
  if(!upgradesUI) return;
  
  upgradesUI.innerHTML = "";
  const sortedUpgrades = Object.keys(upgrades).sort((a, b) => upgrades[a].cost - upgrades[b].cost);
  
  for(const id of sortedUpgrades){
    const u = upgrades[id];
    const owned = game.upgrades[id];
    const affordable = game.money >= u.cost && !purchaseInProgress;
    
    let html = `<div class="tool-card">
      <div class="tool-header">
        <div class="tool-name">${u.name}</div>
        ${owned?`<div class="tool-status active">PURCHASED</div>`:''}
      </div>
      <div class="tool-desc">${u.desc}`;
    
    if(u.effect === "base_bots") html += ` - ${u.value} bots/sec`;
    if(u.effect === "sell_price") html += ` - +${(u.value*100).toFixed(0)}% sell price`;
    if(u.effect === "market_info") html += ` - Shows T3 price trends`;
    
    html += `</div>`;
    
    if(!owned){
      html += `<button onclick="buyUpgrade('${id}')" ${!affordable?'disabled':''}>
        Purchase - $${u.cost.toLocaleString()}
      </button>`;
    }
    
    html += `</div>`;
    upgradesUI.innerHTML += html;
  }
}

function renderMarketplace(){
  const market = document.getElementById("market");
  if(!market) return;

  market.innerHTML = "";
  const sortedTools = Object.keys(tools).sort((a, b) => tools[a].cost - tools[b].cost);

  for(const id of sortedTools){
    const t = tools[id];
    const owned = game.tools[id];
    const affordable = game.money >= t.cost && !purchaseInProgress;

    let html = `<div class="tool-card">
      <div class="tool-header">
        <div class="tool-name">${t.name}</div>
        ${owned ? `<div class="tool-status active">PURCHASED</div>` : ''}
      </div>
      <div class="tool-desc">${t.desc}`;

    if(t.type === "bots") html += ` - ${t.base} bots/sec`;
    if(t.type === "money") html += ` - $${t.base}/sec`;
    if(t.clickable) html += ` - Clickable`;
    if(t.unlocks === "mobile") html += ` - Unlocks Mobile Infrastructure`;

    html += `</div>`;

    // Show purchase button only if not owned
    if(!owned){
      html += `<button onclick="buyTool('${id}')" ${!affordable?'disabled':''}>
        Purchase - $${t.cost.toLocaleString()}
      </button>`;
    }

    html += `</div>`;
    market.innerHTML += html;
  }
}

function renderSkills(){
  const skillsUI = document.getElementById("skills");
  if(!skillsUI) return;

  const skillDefs = [
    {key:"tiers", label:"Bot Tier Distribution", desc:"+5% better tier chances"},
    {key:"prices", label:"Market Efficiency", desc:"+10% sell prices"},
    {key:"generation", label:"Bot Generation Rate", desc:"+10% passive generation"},
    {key:"automation", label:"Automation Efficiency", desc:"+5% tool effectiveness"}
  ];

  const baseCosts = {
    tiers: 5e5,
    prices: 1e6,
    generation: 2e6,
    automation: 5e6
  };

  skillsUI.innerHTML = "";

  skillDefs.forEach(s => {
    const level = game.skills[s.key] || 0;
    const cost = baseCosts[s.key] * Math.pow(1.6, level);
    const canBuy = game.money >= cost && !purchaseInProgress;

    skillsUI.innerHTML += `
      <button
        onclick="upgrade('${s.key}')"
        ${!canBuy ? "disabled" : ""}
      >
        ${s.label}<br>
        <span style="font-size:clamp(10px, 2vw, 11px); color:#8b949e;">
          Level ${level} – $${cost.toLocaleString()}
        </span>
      </button>
    `;
  });
}

function renderAchievements(){
  const ach = document.getElementById("achievements");
  ach.innerHTML = "";
  
  achievements.forEach(a => {
    const done = game.achievements[a.id] || a.check();
    if(done && !game.achievements[a.id]) game.achievements[a.id] = true;
    
    let rewardText = "";
    if(a.reward === "income") rewardText = `+${(a.bonus*100).toFixed(0)}% Income`;
    else if(a.reward === "generation") rewardText = `+${(a.bonus*100).toFixed(0)}% Generation`;
    else if(a.reward === "prestige") rewardText = `+${a.bonus} Effective Prestige`;
    else if(a.reward === "click") rewardText = `+${(a.bonus*100).toFixed(0)}% Click Power`;
    else if(a.reward === "cooldown") rewardText = `−${(a.bonus*100).toFixed(0)}% Cooldowns`;
    else if(a.reward === "automation") rewardText = `+${(a.bonus*100).toFixed(0)}% Automation`;
    else if(a.reward === "special") rewardText = `Special Effect`;
    
    ach.innerHTML += `<div class="achievement ${done?'done':''}">
      <div class="achievement-text">${a.text}</div>
      <div class="achievement-reward">${rewardText}</div>
    </div>`;
  });
}

function renderToolsInterface(){
  const toolsUI = document.getElementById("toolsInterface");
  
  const ownedTools = Object.keys(game.tools).filter(id => {
    return game.tools[id] !== undefined; // Simple check
  });
  
  if(ownedTools.length === 0){
    toolsUI.innerHTML = `<div style="font-size:clamp(10px, 2vw, 11px); color:#8b949e; padding:10px; text-align:center;">Purchase tools from marketplace to use here</div>`;
    return;
  }
  
  if(!game.activeToolTab || !game.tools[game.activeToolTab]){
    game.activeToolTab = ownedTools[0];
  }
  
  let html = '<div class="tool-tabs">';
  ownedTools.forEach(id => {
    html += `<div class="tool-tab ${game.activeToolTab===id?'active':''}" onclick="game.activeToolTab='${id}';render()">
      ${tools[id].name.split(' ')[0]}
    </div>`;
  });
  html += '</div>';
  
  ownedTools.forEach(id => {
    const t = tools[id];
    const owned = game.tools[id];
    html += `<div class="tool-panel ${game.activeToolTab===id?'active':''}" data-tool-id="${id}">
      <div style="margin-bottom:10px;">
        <div style="font-size:clamp(11px, 2.5vw, 13px); font-weight:600; color:#58a6ff; margin-bottom:4px;">${t.name}</div>
        <div style="font-size:clamp(10px, 2vw, 11px); color:#8b949e;">${t.desc}</div>
      </div>`;
    
    if(t.clickable){
      const cd = game.clickCooldowns[id] || 0;
      const clicks = owned.clicks || 0;
      html += `<button onclick="clickTool('${id}')" data-click-btn="${id}" ${cd>0?'disabled':''}>
        <span data-click-text="${id}">Execute Bonus (${clicks}/50)${cd>0?' - '+Math.ceil(cd)+'s':''}</span>
      </button>`;
      html += `<div class="cooldown-bar" data-cooldown-bar="${id}"><div class="cooldown-fill" data-cooldown-fill="${id}" style="width:${cd>0?(1-cd/(t.clickCooldown * getCooldownReduction()))*100:0}%"></div></div>`;
    }
    
    html += '</div>';
  });
  
  toolsUI.innerHTML = html;
}

function updateToolsInterfaceDynamic(){
  const ownedTools = Object.keys(game.tools).filter(id => {
    const t = tools[id];
    return t && t.type;
  });
  
  ownedTools.forEach(id => {
    const t = tools[id];
    const owned = game.tools[id];
    
    if(t.clickable){
      const cd = game.clickCooldowns[id] || 0;
      const clicks = owned.clicks || 0;
      
      // Update click button
      const clickBtn = document.querySelector(`[data-click-btn="${id}"]`);
      if(clickBtn){
        clickBtn.disabled = cd > 0;
        const clickText = document.querySelector(`[data-click-text="${id}"]`);
        if(clickText){
          clickText.textContent = `Execute Bonus (${clicks}/50)${cd>0?' - '+Math.ceil(cd)+'s':''}`;
        }
      }
      
      // Update cooldown bar
      const cooldownBar = document.querySelector(`[data-cooldown-bar="${id}"]`);
      const cooldownFill = document.querySelector(`[data-cooldown-fill="${id}"]`);
      if(cooldownBar && cooldownFill){
        if(cd > 0){
          cooldownBar.style.display = '';
          cooldownFill.style.width = ((1 - cd / (t.clickCooldown * getCooldownReduction())) * 100) + '%';
        } else {
          cooldownBar.style.display = 'none';
        }
      }
    }
  });
}


function drawCharts(){
  drawPieChart();
  drawMoneyGraph();
}

function showPieTooltip(e, segment, total){
  const tooltip = document.getElementById("pieTooltip");
  const canvas = document.getElementById("pieChart");
  const rect = canvas.getBoundingClientRect();

  tooltip.style.display = "block";
  tooltip.style.left = (e.clientX - rect.left + 12) + "px";
  tooltip.style.top = (e.clientY - rect.top + 12) + "px";

  tooltip.innerHTML = `
    <div class="tooltip-label">${segment.fullLabel}</div>
    <div class="tooltip-value">${Math.floor(segment.value).toLocaleString()} bots</div>
    <div class="tooltip-label">${((segment.value/total)*100).toFixed(1)}%</div>
  `;
}

function drawPieChart(){
  const canvas = document.getElementById("pieChart");
  if(!canvas) return;
  
  const ctx = canvas.getContext("2d");
  const rect = canvas.getBoundingClientRect();
  
  if(rect.width === 0 || rect.height === 0) return;
  
  const displayWidth = rect.width;
  const displayHeight = rect.height;
  const dpr = window.devicePixelRatio || 1;

  canvas.width = displayWidth * dpr;
  canvas.height = displayHeight * dpr;

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);

  const centerX = displayWidth / 2;
  const centerY = displayHeight / 2;
  const radius = Math.min(displayWidth, displayHeight) * 0.35;

  ctx.clearRect(0, 0, displayWidth, displayHeight);

  const total = getTotalBots();
  if(total === 0){
    ctx.fillStyle = "#8b949e";
    ctx.font = "12px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("No bots acquired", centerX, centerY);
    return;
  }

  const data = [
    {label:"T1", value:game.bots.t1, color:"#6e7681", fullLabel:"T1 Premium"},
    {label:"T2", value:game.bots.t2, color:"#58a6ff", fullLabel:"T2 Standard"},
    {label:"T3", value:game.bots.t3, color:"#f85149", fullLabel:"T3 Basic"}
  ];
  if(game.unlocks.mobile && game.bots.mobile > 0) {
    data.push({label:"Mobile", value:game.bots.mobile, color:"#ffc107", fullLabel:"Mobile"});
  }

  let currentAngle = -Math.PI / 2;

  data.forEach(segment => {
    const sliceAngle = (segment.value / total) * 2 * Math.PI;

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = segment.color;
    ctx.fill();
    ctx.strokeStyle = "#0d1117";
    ctx.lineWidth = 2;
    ctx.stroke();

    segment.startAngle = currentAngle;
    segment.endAngle = currentAngle + sliceAngle;
    currentAngle += sliceAngle;

    if(sliceAngle > 0.15){
      const labelAngle = (segment.startAngle + segment.endAngle) / 2;
      const labelX = centerX + Math.cos(labelAngle) * (radius * 0.65);
      const labelY = centerY + Math.sin(labelAngle) * (radius * 0.65);

      ctx.fillStyle = "#fff";
      ctx.font = "bold 11px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(segment.label, labelX, labelY);
    }
  });

  canvas.onmousemove = canvas.ontouchmove = (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const x = (clientX - rect.left) * (canvas.width / rect.width);
    const y = (clientY - rect.top) * (canvas.height / rect.height);

    const dx = x / dpr - centerX;
    const dy = y / dpr - centerY;
    const distance = Math.sqrt(dx*dx + dy*dy);
    
    if(distance <= radius){
      let angle = Math.atan2(dy, dx);
      angle = angle - (-Math.PI/2);
      if(angle < 0) angle += 2*Math.PI;

      for(const segment of data){
        let segmentStart = segment.startAngle - (-Math.PI/2);
        let segmentEnd = segment.endAngle - (-Math.PI/2);
        if(segmentStart < 0) segmentStart += 2*Math.PI;
        if(segmentEnd < 0) segmentEnd += 2*Math.PI;
        
        if(segmentEnd < segmentStart){
          if(angle >= segmentStart || angle <= segmentEnd){
            const evt = {clientX, clientY};
            showPieTooltip(evt, segment, total);
            return;
          }
        } else {
          if(angle >= segmentStart && angle <= segmentEnd){
            const evt = {clientX, clientY};
            showPieTooltip(evt, segment, total);
            return;
          }
        }
      }
    }
    document.getElementById("pieTooltip").style.display = "none";
  };

  canvas.onmouseleave = canvas.ontouchend = () => {
    document.getElementById("pieTooltip").style.display = "none";
  };
}

function drawMoneyGraph(){
  const canvas = document.getElementById("moneyGraph");
  const ctx = canvas.getContext("2d");
  const rect = canvas.getBoundingClientRect();
  
  const displayWidth = rect.width;
  const displayHeight = rect.height;
  const dpr = window.devicePixelRatio || 1;

  canvas.width = displayWidth * dpr;
  canvas.height = displayHeight * dpr;

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);

  ctx.clearRect(0, 0, displayWidth, displayHeight);

  ctx.strokeStyle = "#30363d";
  ctx.lineWidth = 1;
  for(let i=0; i<=5; i++){
    const y = (displayHeight / 5) * i;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(displayWidth, y);
    ctx.stroke();
  }

  if(game.moneyGraph.length < 2) return;

  const maxVal = Math.max(...game.moneyGraph, 1);

  ctx.beginPath();
  ctx.strokeStyle = "#58a6ff";
  ctx.lineWidth = 2;

  for(let i=0; i<game.moneyGraph.length; i++){
    const x = (i / (game.moneyGraph.length-1)) * displayWidth;
    const y = displayHeight - (game.moneyGraph[i]/maxVal*displayHeight*0.9);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  ctx.fillStyle = "rgba(88, 166, 255, 0.2)";
  ctx.lineTo(displayWidth, displayHeight);
  ctx.lineTo(0, displayHeight);
  ctx.closePath();
  ctx.fill();
  
  canvas.onmousemove = canvas.ontouchmove = (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const canvasX = (clientX - rect.left) * (canvas.width / rect.width);
    const index = Math.floor((canvasX / canvas.width) * game.moneyGraph.length);

    if(index >= 0 && index < game.moneyGraph.length){
      const tooltip = document.getElementById("moneyTooltip");
      tooltip.style.display = "block";
      tooltip.style.left = (clientX - rect.left + 12) + "px";
      tooltip.style.top = (clientY - rect.top + 12) + "px";

      const pointsFromEnd = game.moneyGraph.length - 1 - index;
      const secondsAgo = pointsFromEnd * 10;
      const hours = Math.floor(secondsAgo / 3600);
      const mins = Math.floor((secondsAgo % 3600) / 60);
      let timeText = "";
      if(hours > 0) timeText = `${hours}h ${mins}m ago`;
      else if(mins > 0) timeText = `${mins}m ago`;
      else timeText = `${secondsAgo}s ago`;
      
      tooltip.innerHTML = `
        <div class="tooltip-label">${timeText}</div>
        <div class="tooltip-value">${Math.floor(game.moneyGraph[index]).toLocaleString()}</div>
      `;
    }
  };

  canvas.onmouseleave = canvas.ontouchend = () => {
    document.getElementById("moneyTooltip").style.display = "none";
  };
}

function exportSave(){
  const data = btoa(JSON.stringify(game));
  const el = document.createElement("textarea");
  el.value = data;
  document.body.appendChild(el);
  el.select();
  document.execCommand("copy");
  document.body.removeChild(el);
  alert("Save data exported to clipboard");
}

function importSave(){
  const data = prompt("Paste save data:");
  if(data){
    try {
      const imported = JSON.parse(atob(data));
      // Better validation
      if(imported && 
         typeof imported === 'object' &&
         imported.bots && 
         typeof imported.bots.t3 !== 'undefined' &&
         typeof imported.money === 'number'){
        
        // Merge with existing game structure
        game = { ...game, ...imported };
        localStorage.setItem(SAVE_KEY, JSON.stringify(game));
        alert("Save data imported successfully");
        location.reload();
      } else {
        alert("Invalid save data format");
      }
    } catch(e) {
      console.error("Import error:", e);
      alert("Invalid save data format");
    }
  }
}

function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

function debugLocalStorage() {
  console.log("=== DEBUG ===");
  console.log("SAVE_KEY:", SAVE_KEY);
  console.log("Has save in localStorage?", localStorage.getItem(SAVE_KEY) ? "YES" : "NO");
  
  const saved = localStorage.getItem(SAVE_KEY);
  if(saved) {
    try {
      const parsed = JSON.parse(saved);
      console.log("Save contains money:", parsed.money);
      console.log("Save contains bots.t3:", parsed.bots?.t3);
      console.log("Save timestamp:", new Date(parsed.lastTick));
    } catch(e) {
      console.error("Parse error:", e);
    }
  }
  
  console.log("Current game money:", game.money);
  console.log("Current game bots:", game.bots);
}

const spreadBtn = document.getElementById('spreadBtn');
spreadBtn.addEventListener('mousedown', startSpread);
spreadBtn.addEventListener('mouseup', stopSpread);
spreadBtn.addEventListener('mouseleave', stopSpread);
spreadBtn.addEventListener('touchstart', (e) => {
  e.preventDefault();
  startSpread();
}, {passive: false});
spreadBtn.addEventListener('touchend', (e) => {
  e.preventDefault();
  stopSpread();
}, {passive: false});

setInterval(update, 100);
update();

if(!Array.isArray(game.moneyGraph)) {
  game.moneyGraph = [];
}

let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    drawCharts();
  }, 250);
});

if(!game.tutorialComplete){
  setTimeout(showTutorial, 500);
}
</script>
</body>
</html>
